<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv = "x-ua-compatible" content = "ie=edge">
    <meta name = "viewport" content = "width=device-width initial-scale=1">
    
    <title>Font Asset Generator</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;700&display=swap" rel="stylesheet"> 

    <style>
        body {
            font-family: 'Roboto', sans-serif !important;
        }
        h1.display-4 {
            font-weight: 100 !important;
        }
        strong {
            font-weight: 700 !important;
        }
    </style>

</head>

<body>

    <div class="container-lg">
    
        <div class="row mt-5">
            <div class="col">
                <h1 class="display-4"><strong>Font Asset</strong> Generator</h1>
                <p class="lead">Generate font assets, i.e., <strong>font description</strong> file (.fnt) and <strong>glyph atlas</strong> (distance map in .png) for <a href="https://webgl-operate.org">webgl-operate</a> glyph rendering.</p>               
            </div>
        </div>

        <div class="row mt-3">
            <div class="col">
                <div class="ratio ratio-21x9">
                    <canvas class="embed-responsive-item w-100" id="canvas"></canvas>
                </div>       
            </div>
        </div>

        <div class="row justify-content-start" id="canvas-nav">
            
            <div class="col-md-2 col-sm-6 col-12 mt-3">
                <div class="input-group input-group-sm">
                    <label class="input-group-text" for="text-aa">Text AA</label>
                    <select class="form-select" id="text-aa">
                        <option value="5">4&times;4 Grid</option>    
                        <option value="4">3&times;3 Grid</option>
                        <option value="3">1&times;3 (vertical)</option>
                        <option value="2">3&times;1 (horizontal)</option>
                        <option value="1" selected>Smooth</option>
                        <option value="0">None</option>
                    </select>
                </div>
            </div>

            <div class="col-md-3 col-sm-6 col-12 mt-3">
                <div class="input-group input-group-sm">
                    <label class="input-group-text" for="super-sampling">Super Sampling</label>
                    <select class="form-select" id="super-sampling">
                        <option value="64">Golden Set, 64 Samples</option>
                        <option value="8">Golden Set, 8 Samples</option>
                        <option value="1024">Random, 256 Samples</option>
                        <option value="1" selected>None, 1 Sample</option>
                    </select>
                </div>
            </div>

            <div class="col-md-4 col-sm-6 col-12 mt-3">
                <div class="input-group input-group-sm">
                    <label class="input-group-text" for="texture-filter">Texture Filter</label>
                    <select class="form-select" id="texture-filter">
                        <option value="16">Anisotrophic 16x</option>
                        <option value="8">Anisotrophic 8x</option>
                        <option value="4">Anisotrophic 4x</option>
                        <option value="3">Trilinear</option>
                        <option value="2" selected>Bilinear</option>
                        <option value="1">Nearest</option>
                    </select>
                    <span class="input-group-text">Debug</span>
                    <div class="input-group-text">
                        <input class="form-check-input mt-0" id="debug-blit" type="checkbox" value="">
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6 col-12 mt-3">
                <div class="input-group input-group-sm">
                    <label class="input-group-text" for="resolution-scale">Resolution Scale</label>
                    <select class="form-select" id="resolution-scale">
                        <option value="2.000">&times; 2.000</option>
                        <option value="1.000" selected>&times; 1.000</option>
                        <option value="0.500">&times; 0.500</option>
                        <option value="0.250">&times; 0.250</option>
                        <option value="0.125">&times; 0.125</option>
                    </select>
                </div>
            </div>
        
        </div>
            
    </div>
        

    <div class="container-lg">

        <div class="row justify-content-center">
            
            <div class="col-lg-6 col-md-10 col-12 mt-5">

                <h4 class="mb-4">STEP 1&ensp;|&ensp;Choose an <strong>existing font</strong> or <strong>upload a font</strong>.</h4>

                <div class="input-group mb-4">
                    <label class="input-group-text" for="input-font">Existing Font</label>
                    <select class="form-select" id="input-font">
                        <option selected value="">Choose...</option>
                        <option value="./open-sans--regular.fnt">Open Sans - Regular</option>
                        <option value="./times-new-roman--regular.fnt">Times New Roman - Regular</option>
                        <option value="./roboto--regular.fnt">Roboto - Regular</option>
                    </select>
                    <!--<button class="btn btn-outline-secondary" type="button">Refresh</button>-->
                </div>

                <div id="file-api-missing-alert" class="alert alert-danger d-none" role="alert">
                    The File APIs, required for font file, are not fully supported in this browser.
                </div>
                <div class="input-group mb-2">
                    <input type="file" class="form-control" id="upload-file" accept="font/*">
                </div>

                <div class="input-group">
                    <label class="input-group-text" for="upload-name">Specify a name</label>
                    <input type="text" class="form-control" id="upload-name" placeholder="font-name-regular">
                    <button class="btn btn-outline-secondary" type="button" id="upload-file">...and <strong>upload</strong></button>
                </div>
            </div>


            <div class="col-lg-6 col-md-10 col-12 mt-5">

                <h4 class="mb-4">STEP 2&ensp;|&ensp;Specify the font <strong>asset format</strong> and <strong>charset</strong>.</h4>
                
                <div class="input-group mb-4">
                    <label class="input-group-text" for="distance-type">Type</label>
                    <select class="form-select" id="distance-type">
                        <!-- fill up automatically based on API capabilities -->
                        <option value="deadrec">Dead Reckoning</option>
                        <option value="parabola" selected>Parabola Envelope</option>
                    </select>
                    <select class="form-select" id="map-type">
                        <!-- fill up automatically based on API capabilities -->
                        <option value="sdf" selected>SDF</option>
                        <option value="MSDF" disabled>MSDF</option>
                        <option value="MTSDF" disabled>MTSDF</option>
                    </select>
                    <select class="form-select" id="bitness">
                        <!-- fill up automatically based on API capabilities -->
                        <option value="8" selected>8 bit</option>
                        <option value="2x8" disabled>16 bit | 2&times;8 bit</option>
                        <option value="16" disabled>16 bit | single</option>
                    </select>
                </div>

                <div class="input-group mb-2">
                    <label class="input-group-text" for="character-set">Character Set:</label>
                    <select class="form-select" id="character-set">
                        <option value="ascii-1967" selected>ASCII 1967</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="input-group mb-3">
                    <label class="input-group-text" for="character-text">Characters:</label>
                    <input type="text" class="form-control" id="character-text" value="" disabled>
                </div>

            </div>
            
        </div>
        

        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-10 col-12 mt-5">

                <h4 class="mb-4">STEP 3&ensp;|&ensp;Customize and tweak <strong>glyph atlas</strong>.</h4>
        
                
                <div class="mb-3 row">
                    <div class="col-3 text-end">
                        <label for="packing-algorithm" class="form-label">Packing Algorithm:</label>
                    </div>
                    <div class="col">
                        <!-- fill up automatically based on API capabilities -->
                        <select class="form-select" id="packing-algorithm">
                            <option value="shelf" selected>Shelf Packing</option>
                            <option value="maxrects">Max Rects Packing</option>
                        </select>
                    </div>
                </div>


                <div class="row mb-3">
                    <div class="col-3 text-end">
                        <label for="fontsize-range" class="form-label">Font Size in <strong>px</strong>:</label>
                    </div>
                    <div class="col">
                        <input type="range" class="form-range" min="8" max="128" step="1" id="fontsize-range" value="64">
                    </div>
                    <div class="col-2">
                        <input type="number" class="form-control form-control-sm"  min="8" max="128" id="fontsize-number" value="64">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-3 text-end">
                        <label for="downscale-range" class="form-label">Down Scale:</label>
                    </div>
                    <div class="col">
                        <input type="range" class="form-range" min="0" max="8" step="1" id="downscale-range" value="4">
                    </div>
                    <div class="col-2">
                        <input type="number" class="form-control form-control-sm" min="0" max="8" id="downscale-number" value="4">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-3 text-end">
                        <label for="padding-range" class="form-label">Padding in <strong>px</strong>:</label>
                    </div>
                    <div class="col">
                        <input type="range" class="form-range" min="-4" max="16" step="1" id="padding-range" value="8">
                    </div>
                    <div class="col-2">
                        <input type="number" class="form-control form-control-sm" min="-4" max="16" id="padding-number" value="8">
                    </div>
                </div>

            </div>


            <div class="col-lg-6 col-md-10 col-12 mt-5">

                <h4 class="mb-4">STEP 4&ensp;|&ensp;Review and access <strong>font assets</strong>.</h4>
        
                <div class="row mb-3">
                    <div class="col-3 text-end">
                        <label for="padding-range" class="form-label">API Cooldown:</label>
                    </div>
                    <div class="col">
                        <div class="progress mt-1" style="height: 1.5em;">
                            <div class="progress-bar" role="progressbar" id="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-3 text-end">
                        <label for="character-whitelist" class="form-label">Preview Text:</label>
                    </div>
                    <div class="col-9">
                        <textarea class="form-control" id="preview-text" rows="4">
Amazingly few discotheques provide
jukeboxes. The quick onyx goblin
jumps over the lazy dwarf.
42 * 138 + 0 = 5796 #pangram</textarea> 
                    </div>
                </div>

            </div>

        </div>


        <div class="container-lg my-5">

            <div class="row justify-content-start my-5">
                <div class="col">
                </div>
            </div>
        
        </div>
        

    </div>


    
    <script src="https://cdn.jsdelivr.net/npm/rxjs@latest/bundles/rxjs.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script>
    <!--<script src="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js"></script>-->
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/webgl-operate@latest/dist/webgl-operate.min.js"></script>


    <script src = "index.js"></script>


    <script>
        if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
            $('#file-api-missing-alert').toggleClass('d-none');
        }

 
        let canvas = null;
        let context = null;
        let controller = null;
        let gl = null;
        let renderer = null;


        // Step-0 Controls - Preview

        const step0 = {
            aaSampling: $('#text-aa'),
            superSampling: $('#super-sampling'),
            textureFilter: $('#texture-filter'),
            resolutionScale: $('#resolution-scale'),
            debugBlit: $('#debug-blit'),
        };

        const bindStep0Controls = () => {

            step0.aaSampling.on('change', (e) => {
                renderer.aaSampling(e.target.value); });

            step0.superSampling.on('change', (e) => {
                controller.multiFrameNumber = e.target.value; });
            
            step0.textureFilter.on('change', (e) => {
                renderer.textureFilter(e.target.value); });
            
            step0.resolutionScale.on('change', (e) => {
                canvas.frameScale = [ e.target.value, e.target.value ]; });

            step0.debugBlit.on('change', (e) => {
                renderer.debugBlit(e.target.checked); });

            step0.aaSampling.trigger('change');
            step0.superSampling.trigger('change');
            step0.textureFilter.trigger('change');
            step0.resolutionScale.trigger('change');
            step0.debugBlit.trigger('change');
        }

        // Step-1 Controls - Font Select/Upload

        const bindStep1Controls = () => {

            const inputFont = $('#input-font');
            inputFont.on('click', (e) => {
                renderer.change(e.target.value);
            });

            const inputFile = $('#input-file');
            const uploadFile = $('#upload-file');
        
            uploadFile.on('click', () => {
                const file = inputFile.get(0).files[0];
                renderer.change(file.name);
            });
        }




        const bindStep2Controls = () => {
        
          
        }

        
        const step3 = {
            packingAlgorithm: $('#packing-algorithm'),

            fontsizeRange: $('#fontsize-range'),
            fontsizeNumber: $('#fontsize-number'),

            downscaleRange: $('#downscale-range'),
            downscaleNumber: $('#downscale-number'),

            paddingRange: $('#padding-range'),
            paddingNumber: $('#padding-number'),
        };

        const bindStep3Controls = () => {
        
            step3.packingAlgorithm.on('input', (e) => {
                dispatchUpdate(); });

            step3.fontsizeRange.on('input', (e) => {
                dispatchUpdate(); step3.fontsizeNumber.val(e.target.value); });
            step3.fontsizeNumber.on('input', (e) => {
                dispatchUpdate(); step3.fontsizeRange.val(e.target.value); });

            step3.downscaleRange.on('input', (e) => {
                dispatchUpdate(); step3.downscaleNumber.val(e.target.value); });
            step3.downscaleNumber.on('input', (e) => {
                dispatchUpdate(); step3.downscaleRange.val(e.target.value); });

            step3.paddingRange.on('input', (e) => {
                dispatchUpdate(); step3.paddingNumber.val(e.target.value); });
            step3.paddingNumber.on('input', (e) => {
                dispatchUpdate(); step3.paddingRange.val(e.target.value); });
        }

        
        const bindStep4Controls = () => {
    
            const previewText = $('#preview-text');
            previewText.on('input', (e) => renderer.previewText(e.target.value));

            previewText.trigger('input');
        }


        // Initialize and Bind

        const cs_ascii1967 = ` !"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_\`abcdefghijklmnopqrstuvwxyz{|}~`;

        window.onload = () => { 
            
            const element = $('#canvas')[0];

            canvas = new gloperate.Canvas(element, {
                alpha: false, antialias: false, depth: true, failIfMajorPerformanceCaveat: false,
                premultipliedAlpha: false, preserveDrawingBuffer: false, stencil: false,
            });

            var blocker = new gloperate.viewer.EventBlocker(canvas.element);
                blocker.block('contextmenu');

            element.addEventListener('click', (event) => {
                if (event.ctrlKey) { gloperate.viewer.Fullscreen.toggle(element); }
            });

            context = canvas.context;
            controller = canvas.controller;
            gl = canvas.context.gl;

            renderer = new Renderer();            
            canvas.renderer = renderer; 


            bindStep0Controls();
            bindStep1Controls();
            bindStep2Controls();
            bindStep3Controls();
            bindStep4Controls();
        }


        // API Cooldown - brief delay to reduce API call frequency

        let updateTimer = null;
        let updateTime = 0;
        let updateDelay = 4000;
        
        const update = () => {
            clearTimeout(updateTimer);
            updateTimer = null;

            // actual API call dispatches
        }

        const dispatchUpdate = () => {

            if(updateTimer) {
                clearTimeout(updateTimer);
            }
            updateTime = performance.now() + updateDelay;
            updateTimer = setTimeout(update, updateDelay);
        }

        const progressBar = $('#progress-bar');
        setInterval(() => {
            if(updateTimer == null) {
                progressBar.css('width', `0%`);
                return;
            }
            const progress = (updateTime - performance.now()) / updateDelay;
            progressBar.css('width', `${progress * 100.0}%`);
        }, 50);


    </script>  

</body>

</html>